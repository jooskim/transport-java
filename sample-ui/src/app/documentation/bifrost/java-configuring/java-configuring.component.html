<appfab-java-badges></appfab-java-badges>
<h1>
    Configuring your Spring Application (Java)
</h1>

<p>
    The BifrÃ¶st makes use of Spring's magic under the covers, in a significant way. This has advantages and disadvantages. It's good because
    we don't have to re-invent the wheel. It's bad because it means the Java version of the BifrÃ¶st is dependent on Spring to operate.
</p>
<p>
    We took the position that Spring is the foundation of every single Java based service in VMware.
</p>

<hr/>

<h3>
    The BifrÃ¶st Config Class.
</h3>

<p>
    We use the <code class="clr-code">@Configuration</code> annotation provided by Spring to set things up. We also then use the
    built in STOMP, Messaging, Broker and WebSocket support.
</p>

<p>
    When creating your configuration class, you need to implement the <code class="clr-code">BifrostBridgeConfigurer</code>.
    This interface allows you to define which endpoints your want your application to expose. This will default to '/fabric'.
</p>
<p>
    To enable the BifrÃ¶st functionality for automatic local and remote broker integration, you need the <code class="clr-code">@EnableBifrost</code> annotation also.
    You can use the bus internally without this, but you won't get the benefits of connecting the bus to the fabric.
</p>
<hr/>
<h3>
    What is an endpoint?
</h3>

<p>
    An endpoint is the destination you want to expose the STOMP pub-sub interface used by the Fabric. The choice is up to you, however
    for consistency across applications, we recommend the default '/fabric' endpoint.
</p>
<hr/>
<p>
    Inside your configuration, you can configure the endpoints, the allows origins (defaults to all), local broker (/topic) definitions and
    the publication prefix (/pub)
</p>
<p>
    The publication prefix is where messages are pushed into the local broker. You should not directly push to /topic, because you will
    receive an echo back yourself. The publication prefix ensures all subscribers get your message, but you don't get a copy back yourself if you're
    also subscribed to a destination.
</p>

<p>
    Here is an example of a Configuration that uses all the defaults. There isn't a need to change any of this, unless you have specific needs or conflicts.
</p>

<h3>MyAppFabricConfiguration</h3>
<pre class="code"><code class="language-java" ngNonBindable>package com.vmware.skyscraper.configs;

import com.vmware.bifrost.bridge.spring.config.BifrostBridgeConfiguration;
import com.vmware.bifrost.bridge.spring.config.BifrostBridgeConfigurer;
import com.vmware.bifrost.bridge.spring.config.annotation.EnableBifrost;
import org.springframework.context.annotation.Configuration;
import org.springframework.messaging.simp.config.MessageBrokerRegistry;
import org.springframework.web.socket.config.annotation.AbstractWebSocketMessageBrokerConfigurer;
import org.springframework.web.socket.config.annotation.EnableWebSocketMessageBroker;
import org.springframework.web.socket.config.annotation.StompEndpointRegistry;

/**
 * Fabric Configuration.
 */
@Configuration
@EnableBifrost
@EnableWebSocketMessageBroker
public class MyAppFabricConfiguration extends AbstractWebSocketMessageBrokerConfigurer
        implements BifrostBridgeConfigurer &#123;

    @Override
    public void configureMessageBroker(MessageBrokerRegistry config) &#123;
        config.enableSimpleBroker("/topic");
        config.setApplicationDestinationPrefixes("/pub");
    &#125;

    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) &#123;
        registry.addEndpoint("/fabric").setAllowedOrigins("*");
    }

    @Override
    public void registerBifrostDestinationPrefixes(BifrostBridgeConfiguration configuration) &#123;
        configuration.addBifrostDestinationPrefixes("/topic", "/pub");
    }
}
</code></pre>

<h4 class="emphasis">
    And you're done!
</h4>

<hr/>
<h3>
    How do I know I am done?
</h3>

<p>When you boot you application, you will see something like the following in your console.</p>

<pre class="console-darkgrey">2019-03-01 14:34:42.968  <span class="console-green">INFO</span>  <span class="console-pink">50737</span>  --- [main] <span class="console-blue">o.s.w.s.s.s.WebSocketHandlerMapping</span>       : <span class="console-white">Mapped URL path [/bifrost] onto handler of type [class org.springframework.web.socket.server.support.WebSocketHttpRequestHandler]</span>
2019-03-01 14:34:42.969  <span class="console-green">INFO</span>  <span class="console-pink">50737</span>  --- [main] <span class="console-blue">o.s.w.s.s.s.WebSocketHandlerMapping</span>       : <span class="console-white">Mapped URL path [/fabric] onto handler of type [class org.springframework.web.socket.server.support.WebSocketHttpRequestHandler]</span>
2019-03-01 14:34:43.154  <span class="console-green">INFO</span>  <span class="console-pink">50737</span>  --- [main] <span class="console-blue">.WebSocketAnnotationMethodMessageHandler</span>  : <span class="console-white">Mapped "&#123;[/&#123;topicDestination&#125;],messageType=[MESSAGE]&#125;" onto public void com.vmware.bifrost.bridge.spring.controllers.MessageController.bridgeMessage(com.vmware.bifrost.bridge.Request,java.lang.String) throws com.vmware.bifrost.bridge.RequestException</span>
2019-03-01 14:34:43.887  <span class="console-green">INFO</span>  <span class="console-pink">50737</span>  --- [main] <span class="console-blue">com.vmware.bifrost.bus.EventBusImpl</span>       : ðŸŒˆ  <strong class="console-pink">Starting BifrÃ¶st</strong>
2019-03-01 14:34:43.912  <span class="console-green">DEBUG</span> <span class="console-pink">50737</span>  --- [main] <span class="console-blue">com.vmware.bifrost.bus.EventBusImpl</span>       : ðŸ”¹  <span class="console-grey">Initializing BifrÃ¶st Service: RestService</span>
2019-03-01 14:34:43.912  <span class="console-green">INFO</span>  <span class="console-pink">50737</span>  --- [main] <span class="console-blue">c.v.bifrost.core.operations.RestService</span>   : ðŸ“£  <span class="console-white">RestService initialized, handling requests on channel: <strong class="console-pink">bifrost-services::REST</strong></span></pre>
