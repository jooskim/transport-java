<h1>Service Adapter Specification</h1>

<h3>Specification Document: testing.json</h3>

<p>
    By convention, <code class="clr-code">testing.json</code> contains specifications for modifying the behavior of
    the autogenerated <code class="clr-code">REST Mock Service</code> (described in detail in a later advanced chapter),
    as well as the autogenerated unit tests for a Service Adapter.
</p>

<p>
    Here is an example of a testing specification modified from the <strong class="emphasis">reservation</strong> Service Adapter:
</p>
<pre class="code" ><code class="language-json" ngNonBindable>
&#123;
    "testing": [
        &#123;
            "defaults": [
                &#123;
                  "class": "ReservationWindow", "default": "UpcomingReservationWindow"
                &#125;
            ],
            "initializers": [
                &#123;
                    "class": "ReservationUtil",
                    "method": "initializeStoreWithMocks",
                    "params": [
                        &#123;
                            "param": "ReservationMocks.MockUpcomingReservationWindow()",
                            "container": "map",
                            "nested": "array",
                            "key": "YourCustomKey"
                        &#125;
                    ],
                    "imports": [
                        &#123;
                            "import": "ReservationUtil",
                            "path": "@vmc/utilities/reservation/reservation.util"
                        &#125;,
                        &#123;
                            "import": "ReservationMocks",
                            "service": "reservation"
                        &#125;
                    ]
                &#125;
            ]
        &#125;
    ]
&#125;
</code></pre>
<p>
    In the above, we have specified two testing properties:
</p>

<table class="table table-noborder flag-table">
    <thead>
    <tr>
        <th class="left flag-header">Property</th>
        <th>Description</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="left flag">defaults</td>
        <td class="flag-value">This property specifies that in the <strong class="emphasis">Mocked REST Service</strong>,
            whenever the specified <code class="clr-code">class</code> is returned from an API call (mocked),
            it should, instead, return the mocked class specified by <code class="clr-code">defaults</code> as shown
            in the above example specification. More details below.
        </td>
    </tr>
    <tr>
        <td class="left flag">initializers</td>
        <td class="flag-value">Sometimes, in autogenerated unit tests, it is necessary to preset the test environment with
            some custom code, encapsulated in a function call with some arguments. This property allows for the specification
            of such an initializer function, along with zero or more arguments that it should be called with, as shown in the
            above example specification. More details below.
        </td>
    </tr>
    </tbody>
</table>

<hr/>
<h3>Specifying Replacement Responses In The Mocked REST Service</h3>

<p>
    In the example specification for <code class="clr-code">defaults</code> above, we have specified that whenever
    the <strong class="emphasis">Mocked REST Service</strong> for a Service Adapter would have otherwise returned
    the class <code class="clr-code">ReservationWindow</code> (including container or nesting) as specified by the
    <code class="clr-code">class</code> property, it should, instead
    return the mock indicated by <code class="clr-code"><code class="clr-code">UpcomingReservationWindow</code></code>
    (prepended with <strong class="emphasis">Mocked</strong> and appended with <strong class="emphasis">parentheses</strong>,
    as specified by the <code class="clr-code">default</code> property.
</p>
<p>
    This results in the following code being autogenerated in 
</p>
<pre class="code" ><code class="language-typescript" ngNonBindable>
export class MockReservationRestService extends AbstractAutoRestMock &#123;
    :

    protected httpPost(restRequestObject: RestObject, args?: MessageArgs) &#123;
        switch (restRequestObject.apiClass as string) &#123;
            case 'API_OrgsOrgTbrsReservation': &#123;	// postTbrs
                let jsonMap = &#123;&#125;;
                jsonMap['# This is the default string for tests #'] = [ReservationMocks.MockUpcomingReservationWindow()]);
                this.handleData(jsonMap, restRequestObject, args);
                break;
            &#125;
    
    :
</code></pre>

<p>
    This is useful when the API response is a polymorphic parent class in the API Specification Document(s), but a
    polymorphic child class is desired in unit tests, or even a custom mock instance of the parent class. Of course, the referenced
    mock must already have been specified in <code class="clr-code">mocks.json</code>. We could have specified
    <code class="language-json">"key": "SomeCustomKey</code>, which would have replaced the default map key
    <code class="clr-code">'# This is the default string for tests #'</code> above.
</p>

<p>
    Note that it is not necessary to specify the <code class="clr-code">CommonType</code> (container/nested/type) above, as it is inferred from
    the response type from the API call.
</p>
<hr/>

<h3>Specifying Initializers In Autogenerated Unit Tests</h3>
<p>
    In the example specification for <code class="clr-code">initializers</code> above, we have specified that
    before each unit test, we would like to call a static method named <code class="clr-code">initializeStoreWithMocks</code>,
    specified using the <code class="clr-code">method</code> property,
    that is implemented in the class <code class="clr-code">ReservationUtil</code> as specified with the
    <code class="clr-code">class</code> property,
    and pass it the arguments described in the <code class="clr-code">params</code> array of qualifications.
</p>
<p>
    In our example, we only have one argument, that is derived from calling
    <code class="clr-code">ReservationMocks.MockUpcomingReservationWindow()</code>, as specified by the <code class="clr-code">param</code>
    property, and we declare that this is an ES6 Map class that has a nested array. We also indicated that we would like the map
    key to be the string <code class="clr-code">YourCustomKey</code>, as specified by the <code class="clr-code">key</code>
    property. Note the use of <code class="clr-code">CommonType</code> in the qualifications. If <code class="clr-code">key</code>
    had not been specified, the default string <code class="clr-code">'# This is the default string for tests #'</code> would
    have been used as the map key.
</p>
<p>
    For Service Adapters written in Typescript, the example specification above results in the following code being autogenerated in
    the unit tests for this Service Adapter:
</p>

<pre class="code" ><code class="language-typescript" ngNonBindable>
    beforeEach(() =&gt; &#123;
        bus = BusTestUtil.bootBus();
        UserUtil.createUserStoreForTests();
        // Custom Test Initializers from testing.json
        const containerMap = new Map();
        containerMap.set('YourCustomKey', [ReservationMocks.MockUpcomingReservationWindow()]);
        ReservationUtil.initializeStoreWithMocks(containerMap);

        restService = new MockReservationRestService();
        reservationService = new ReservationService();
    &#125;);
</code></pre>

<hr/>

<p>
    That's it! This is all you need to specify unit test and mock REST service hints!
</p>
