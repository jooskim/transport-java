image: appfabric-service.artifactory.eng.vmware.com/appfabric-build:1.0

services:
- name: docker:dind

stages:
- test
- build
- publish

cache: {}

test:unit:
  stage: test
  script:
  - echo "Run unit tests"  
  - cd ./java 
  - ./gradlew test  
  - ./gradlew jacocoTestReport
  - cat ./build/reports/jacoco/test/html/index.html | sed -rn 's/.*Total[^%]*>([0-9]{1,3})%.*/Total test coverage:\1%\n/p'

  artifacts:
    paths:
    - java/build/reports/jacoco/

    expire_in: 1 week
  when: always
  only:
  - pushes
  - web

build:bifrost:
  stage: build
  script:
  - echo "Building vmw-bifrost"
  - cd ./java
  - ./gradlew assemble
  artifacts:
    paths:
    - java/build/libs
    expire_in: 1 week
  when: on_success
  only:
  - pushes
  - web

build:ui:
  stage: build
  tags:
  - use-docker
  variables:
    ENV: prd
  script:
  - npm --unsafe-perm --prefix sample-ui install
  - ./scripts/run-unittests.sh ci
  - ./scripts/build-ui.sh
  artifacts:
    paths:
    - sample-ui/dist # check if this right
    expire_in: 1 week
  when: on_success
  only:
  - pushes
  - web

publish:bifrost:
  stage: publish
  dependencies:
  - build:bifrost
  script:  
  - echo "Publishing vmw-bifrost"
  - cd ./java
  - ./gradlew publish -PbuildType=snapshot
  when: on_success
  only:
  - master

publish:ui:
  stage: publish
  tags:
  - use-docker
  variables:
    DOCKER_HOST: "tcp://docker:2375"
    TARGET_TAG: ${CI_PIPELINE_ID}
  dependencies:
  - build:ui
  script:
  - ./scripts/build-image.sh -t ${TARGET_TAG} -n app-fabric-ui
  - docker login ${REGISTRY_PREFIX}
  - docker push ${REGISTRY_PREFIX}/app-fabric-ui:${TARGET_TAG}
  - ./scripts/deploy-ui.sh
  when: on_success
  only:
  - master

